<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>WebXR Walkable Rigged Character</title>

<style>
html,body{margin:0;overflow:hidden;background:#000;font-family:system-ui}
#ui{position:fixed;inset:0;pointer-events:none;color:#fff}
#start{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:auto}
#start button{padding:20px 28px;font-size:20px;border-radius:18px;border:none;background:#2563eb;color:#fff}
#hint{position:absolute;top:14px;left:50%;transform:translateX(-50%);
background:rgba(0,0,0,.6);padding:10px 14px;border-radius:14px}
#controls{position:absolute;bottom:20px;left:0;right:0;display:flex;justify-content:center;gap:12px;pointer-events:auto}
button.ctrl{padding:14px 18px;border-radius:14px;border:none;background:rgba(255,255,255,.25);color:#fff}
.hidden{display:none}
</style>
</head>

<body>
<div id="ui">
  <div id="hint">Move phone to detect surface</div>
  <div id="controls" class="hidden">
    <button class="ctrl" id="left">◀</button>
    <button class="ctrl" id="forward">▲</button>
    <button class="ctrl" id="right">▶</button>
  </div>
  <div id="start">
    <button id="startBtn">Start AR</button>
  </div>
</div>

<script type="module">
import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js";
import { GLTFLoader } from "https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/loaders/GLTFLoader.js";


let scene,camera,renderer;
let session,refSpace,viewerSpace,hitTestSource;
let reticle;
let character,mixer,actions={},activeAction;
let placed=false;
let keys={left:false,right:false,forward:false};
let clock=new THREE.Clock();

init();

function init(){
  scene=new THREE.Scene();
  camera=new THREE.PerspectiveCamera();

  renderer=new THREE.WebGLRenderer({alpha:true,antialias:true});
  renderer.xr.enabled=true;
  renderer.setSize(innerWidth,innerHeight);
  document.body.appendChild(renderer.domElement);

  scene.add(new THREE.HemisphereLight(0xffffff,0x444444,1.6));

  createReticle();
  loadCharacter();
}

function createReticle(){
  reticle=new THREE.Mesh(
    new THREE.RingGeometry(0.06,0.08,32),
    new THREE.MeshBasicMaterial({color:0x22c55e})
  );
  reticle.rotation.x=-Math.PI/2;
  reticle.visible=false;
  scene.add(reticle);
}

function loadCharacter(){
  new GLTFLoader().load(
    "https://threejs.org/examples/models/gltf/RobotExpressive/RobotExpressive.glb",
    gltf=>{
      character=gltf.scene;
      character.scale.setScalar(0.25);
      character.visible=false;
      scene.add(character);

      mixer=new THREE.AnimationMixer(character);
      gltf.animations.forEach(a=>{
        actions[a.name]=mixer.clipAction(a);
      });

      play("Idle");
    }
  );
}

async function startAR(){
  session=await navigator.xr.requestSession("immersive-ar",{
    requiredFeatures:["hit-test"],
    optionalFeatures:["local-floor","dom-overlay"],
    domOverlay:{root:document.body}
  });

  renderer.xr.setSession(session);
  refSpace=await session.requestReferenceSpace("local-floor");
  viewerSpace=await session.requestReferenceSpace("viewer");
  hitTestSource=await session.requestHitTestSource({space:viewerSpace});

  renderer.setAnimationLoop(onFrame);
  document.getElementById("start").classList.add("hidden");

  session.addEventListener("select",placeCharacter);
}

function placeCharacter(){
  if(!reticle.visible || placed || !character) return;
  placed=true;

  character.position.copy(reticle.position);
  character.visible=true;

  document.getElementById("controls").classList.remove("hidden");
  document.getElementById("hint").textContent="Use buttons to walk";
}

function onFrame(t,frame){
  const dt=clock.getDelta();
  if(mixer) mixer.update(dt);

  const hits=frame.getHitTestResults(hitTestSource);
  if(hits.length>0 && !placed){
    const pose=hits[0].getPose(refSpace);
    reticle.visible=true;
    reticle.position.set(
      pose.transform.position.x,
      pose.transform.position.y,
      pose.transform.position.z
    );
  }

  updateMovement();
  renderer.render(scene,camera);
}

function updateMovement(){
  if(!placed || !character) return;

  let moving=false;
  const speed=0.02;

  if(keys.left) character.rotation.y+=0.05;
  if(keys.right) character.rotation.y-=0.05;

  if(keys.forward){
    character.translateZ(-speed);
    moving=true;
  }

  if(moving) play("Walking");
  else play("Idle");
}

function play(name){
  if(activeAction===actions[name]) return;
  if(activeAction) activeAction.fadeOut(0.2);
  activeAction=actions[name];
  activeAction.reset().fadeIn(0.2).play();
}

document.getElementById("startBtn").onclick=startAR;

["left","right","forward"].forEach(k=>{
  document.getElementById(k).onpointerdown=()=>keys[k]=true;
  document.getElementById(k).onpointerup=()=>keys[k]=false;
});
</script>
</body>
</html>
