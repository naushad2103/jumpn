<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Accurate WebXR Character Placement</title>

<style>
html,body{margin:0;overflow:hidden;background:#000;font-family:system-ui}
#ui{position:fixed;inset:0;pointer-events:none;color:#fff}
#start{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:auto}
#start button{padding:20px 28px;font-size:20px;border-radius:18px;border:none;background:#2563eb;color:#fff}
#hint{position:absolute;top:14px;left:50%;transform:translateX(-50%);
background:rgba(0,0,0,.6);padding:10px 14px;border-radius:14px}
#controls{position:absolute;bottom:20px;left:0;right:0;display:flex;justify-content:center;gap:12px;pointer-events:auto}
button.ctrl{padding:14px 18px;border-radius:14px;border:none;background:rgba(255,255,255,.25);color:#fff}
.hidden{display:none}
</style>
</head>

<body>
<div id="ui">
  <div id="hint">Move phone to detect surface</div>
  <div id="controls" class="hidden">
    <button class="ctrl" id="fwd">▲</button>
    <button class="ctrl" id="left">◀</button>
    <button class="ctrl" id="right">▶</button>
  </div>
  <div id="start">
    <button id="startBtn">Start AR</button>
  </div>
</div>

<script type="module">
import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js";

let scene,camera,renderer;
let session,refSpace,viewerSpace,hitTestSource;
let reticle,character;
let placed=false;

init();

function init(){
  scene=new THREE.Scene();
  camera=new THREE.PerspectiveCamera();

  renderer=new THREE.WebGLRenderer({alpha:true,antialias:true});
  renderer.xr.enabled=true;
  renderer.setSize(innerWidth,innerHeight);
  document.body.appendChild(renderer.domElement);

  scene.add(new THREE.HemisphereLight(0xffffff,0x444444,1.5));

  createReticle();
  createCharacter();
}

function createReticle(){
  const geo=new THREE.RingGeometry(0.06,0.08,32);
  const mat=new THREE.MeshBasicMaterial({color:0x22c55e});
  reticle=new THREE.Mesh(geo,mat);
  reticle.rotation.x=-Math.PI/2;
  reticle.visible=false;
  scene.add(reticle);
}

function createCharacter(){
  character=new THREE.Group();

  const body=new THREE.Mesh(
    new THREE.CylinderGeometry(0.06,0.06,0.14,16),
    new THREE.MeshStandardMaterial({color:0x3b82f6})
  );
  body.position.y=0.07;

  const head=new THREE.Mesh(
    new THREE.SphereGeometry(0.05,16,16),
    new THREE.MeshStandardMaterial({color:0xfbbf24})
  );
  head.position.y=0.15;

  character.add(body,head);
  character.visible=false;
  scene.add(character);
}

async function startAR(){
  session=await navigator.xr.requestSession("immersive-ar",{
    requiredFeatures:["hit-test"],
    optionalFeatures:["local-floor","dom-overlay"],
    domOverlay:{root:document.body}
  });

  renderer.xr.setSession(session);
  refSpace=await session.requestReferenceSpace("local-floor");
  viewerSpace=await session.requestReferenceSpace("viewer");
  hitTestSource=await session.requestHitTestSource({space:viewerSpace});

  renderer.setAnimationLoop(onFrame);
  document.getElementById("start").classList.add("hidden");

  session.addEventListener("select",placeCharacter);
}

function onFrame(t,frame){
  const hits=frame.getHitTestResults(hitTestSource);
  if(hits.length>0 && !placed){
    const pose=hits[0].getPose(refSpace);
    reticle.visible=true;
    reticle.position.set(
      pose.transform.position.x,
      pose.transform.position.y,
      pose.transform.position.z
    );
  }
  renderer.render(scene,camera);
}

function placeCharacter(){
  if(!reticle.visible || placed) return;
  placed=true;

  character.position.copy(reticle.position);
  character.visible=true;

  document.getElementById("controls").classList.remove("hidden");
  document.getElementById("hint").textContent="Character placed ✔";
}

document.getElementById("startBtn").onclick=startAR;
</script>
</body>
</html>
